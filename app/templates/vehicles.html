{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-black py-10">
    <div class="max-w-xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Form Card -->
        <div class="bg-gray-900 overflow-hidden shadow-lg rounded-2xl border border-gray-800">
            <!-- Header with gradient -->
            <div class="bg-gradient-to-r from-red-600 to-red-800 px-6 py-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-black rounded-full p-2">
                        <svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                    </div>
                    <h2 class="ml-3 text-xl font-bold text-white">Add New Vehicle</h2>
                </div>
            </div>
            
            <!-- Form Content -->
            <div class="p-6">
                <form id="vehicleForm" class="space-y-5">
                    <div class="space-y-1">
                        <label for="vehicle_number" class="block text-sm font-medium text-white">Vehicle Number</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <input type="text" id="vehicle_number" name="vehicle_number" required
                                class="pl-10 block w-full rounded-md border-gray-800 bg-gray-800 text-white shadow-sm focus:border-red-500 focus:ring-red-500 text-sm"
                                placeholder="e.g. KA01AB1234">
                        </div>
                        <p class="mt-1 text-xs text-gray-400">Enter the registration number exactly as it appears on the vehicle documents</p>
                    </div>
                    
                    <div class="space-y-1">
                        <label for="owner_name" class="block text-sm font-medium text-white">Owner Name</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <input type="text" id="owner_name" name="owner_name" required
                                class="pl-10 block w-full rounded-md border-gray-800 bg-gray-800 text-white shadow-sm focus:border-red-500 focus:ring-red-500 text-sm"
                                placeholder="Full name of vehicle owner">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label for="model" class="block text-sm font-medium text-white">Model</label>
                            <input type="text" id="model" name="model"
                                class="block w-full rounded-md border-gray-800 bg-gray-800 text-white shadow-sm focus:border-red-500 focus:ring-red-500 text-sm"
                                placeholder="Vehicle model">
                        </div>
                        <div class="space-y-1">
                            <label for="year" class="block text-sm font-medium text-white">Year</label>
                            <input type="number" id="year" name="year"
                                class="block w-full rounded-md border-gray-800 bg-gray-800 text-white shadow-sm focus:border-red-500 focus:ring-red-500 text-sm"
                                placeholder="Manufacturing year">
                        </div>
                    </div>
                    
                    <div class="space-y-1">
                        <label for="additional_details" class="block text-sm font-medium text-white">Additional Details</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute top-3 left-3 flex items-start pointer-events-none">
                                <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                            <textarea id="additional_details" name="additional_details" rows="3"
                                class="pl-10 block w-full rounded-md border-gray-800 bg-gray-800 text-white shadow-sm focus:border-red-500 focus:ring-red-500 text-sm"
                                placeholder="Color, engine number, chassis number, etc."></textarea>
                        </div>
                        <p class="mt-1 text-xs text-gray-400">Optional: Include any additional information about the vehicle</p>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="pt-3">
                        <button type="submit" 
                            class="w-full inline-flex justify-center items-center px-4 py-3 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all">
                            <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                            </svg>
                            Generate QR Code
                        </button>
                    </div>
                </form>
                
                <!-- QR Code Display Section (Hidden by default) -->
                <div id="qrCodeDisplay" class="mt-8 hidden">
                    <div class="border-t border-gray-800 pt-6">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <svg class="h-5 w-5 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                            </svg>
                            Generated QR Code
                        </h3>
                        
                        <div class="bg-gray-800 p-5 rounded-xl border border-gray-800 flex flex-col items-center">
                            <div class="bg-white p-3 rounded-lg shadow-md border border-gray-700 mb-4">
                                <img id="qrCodeImage" class="w-48 h-48" alt="QR Code">
                            </div>
                            
                            <div class="text-sm text-gray-300 text-center mb-4">
                                <p>This QR code contains encrypted vehicle information with a digital signature.</p>
                                <p class="mt-1">Use it for verification with the Vehicle Verification System.</p>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button id="printQrBtn" class="inline-flex items-center px-3 py-2 border border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-300 bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                    <svg class="h-5 w-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                    </svg>
                                    Print
                                </button>
                                <button id="downloadQrBtn" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Download
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Information Card -->
        <div class="mt-6 bg-gray-900 overflow-hidden shadow-md rounded-2xl border border-gray-800">
            <div class="bg-gradient-to-r from-gray-800 to-black px-6 py-3">
                <h3 class="text-base font-semibold text-white">Important Information</h3>
            </div>
            <div class="p-5">
                <ul class="space-y-3 text-sm text-gray-300">
                    <li class="flex">
                        <svg class="h-5 w-5 text-red-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Enter all details accurately as they appear in official vehicle documents.
                    </li>
                    <li class="flex">
                        <svg class="h-5 w-5 text-red-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        The generated QR code is cryptographically signed for added security.
                    </li>
                    <li class="flex">
                        <svg class="h-5 w-5 text-red-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Each QR code is linked to your account and can be verified by authorized personnel.
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const vehicleForm = document.getElementById('vehicleForm');
    const qrCodeDisplay = document.getElementById('qrCodeDisplay');
    const qrCodeImage = document.getElementById('qrCodeImage');
    const printQrBtn = document.getElementById('printQrBtn');
    const downloadQrBtn = document.getElementById('downloadQrBtn');
    
    // Form submission
    vehicleForm.addEventListener('submit', handleFormSubmit);
    
    // Button event listeners
    printQrBtn.addEventListener('click', printQrCode);
    downloadQrBtn.addEventListener('click', downloadQrCode);
});

async function handleFormSubmit(e) {
    e.preventDefault();
    
    // Show loading state on button
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalButtonContent = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Generating...
    `;
    
    // Gather form data
    const vehicleNumber = document.getElementById('vehicle_number').value;
    const ownerName = document.getElementById('owner_name').value;
    const model = document.getElementById('model').value;
    const year = document.getElementById('year').value;
    const additionalDetails = document.getElementById('additional_details').value;
    
    try {
        // Create form data object to match backend API
        const formData = new FormData();
        formData.append('vehicle_number', vehicleNumber);
        formData.append('owner_name', ownerName);
        formData.append('model', model);
        formData.append('year', year);
        formData.append('additional_details', additionalDetails);
        
        // Call API to generate QR code - using your actual backend endpoint
        const response = await fetch('/api/vehicles/add', {
            method: 'POST',
            body: formData
        });
        
        // Parse response
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to add vehicle');
        }
        
        // Display QR code
        const qrCodeImage = document.getElementById('qrCodeImage');
        qrCodeImage.src = `data:image/png;base64,${data.qr_code}`;
        
        // Show QR code section with smooth animation
        const qrCodeDisplay = document.getElementById('qrCodeDisplay');
        qrCodeDisplay.classList.remove('hidden');
        qrCodeDisplay.style.opacity = '0';
        qrCodeDisplay.style.transform = 'translateY(20px)';
        
        // Scroll to QR section
        setTimeout(() => {
            qrCodeDisplay.style.transition = 'opacity 0.5s, transform 0.5s';
            qrCodeDisplay.style.opacity = '1';
            qrCodeDisplay.style.transform = 'translateY(0)';
            
            qrCodeDisplay.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }, 100);
        
        showToast('Vehicle added and QR code generated successfully', 'success');
        
    } catch (error) {
        console.error('Error adding vehicle:', error);
        showToast(error.message || 'Failed to add vehicle', 'error');
    } finally {
        // Restore button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalButtonContent;
    }
}

function printQrCode() {
    const qrImage = document.getElementById('qrCodeImage');
    const vehicleNumber = document.getElementById('vehicle_number').value;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Vehicle QR Code - ${vehicleNumber}</title>
                <style>
                    body {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        height: 100vh;
                        margin: 0;
                        font-family: system-ui, -apple-system, sans-serif;
                    }
                    .container {
                        text-align: center;
                        max-width: 500px;
                        padding: 2rem;
                    }
                    img {
                        max-width: 250px;
                        height: auto;
                        border: 1px solid #e5e7eb;
                        padding: 1rem;
                        margin-bottom: 1.5rem;
                    }
                    h2 {
                        margin-bottom: 0.5rem;
                        color: #111827;
                        font-size: 1.25rem;
                    }
                    p {
                        color: #6b7280;
                        font-size: 0.875rem;
                        margin-bottom: 1.5rem;
                    }
                    .details {
                        text-align: left;
                        border: 1px solid #e5e7eb;
                        border-radius: 0.5rem;
                        padding: 1rem;
                        margin-top: 1.5rem;
                        background-color: #f9fafb;
                    }
                    .details p {
                        margin: 0.5rem 0;
                    }
                    .vehicle-number {
                        font-weight: bold;
                        font-size: 1.25rem;
                        color: #1f2937;
                    }
                    .footer {
                        margin-top: 2rem;
                        font-size: 0.75rem;
                        color: #9ca3af;
                    }
                    @media print {
                        .no-print {
                            display: none;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <h2>Vehicle Verification QR Code</h2>
                    <p class="vehicle-number">${vehicleNumber}</p>
                    <img src="${qrImage.src}" alt="Vehicle QR Code">
                    <p>Scan with the Vehicle Verification System app</p>
                    <div class="details">
                        <p><strong>Registration:</strong> ${vehicleNumber}</p>
                        <p><strong>Date Generated:</strong> ${new Date().toLocaleString()}</p>
                    </div>
                    <button class="no-print" onclick="window.print()" style="margin-top: 1.5rem; padding: 0.5rem 1rem; background-color: #dc2626; color: white; border: none; border-radius: 0.375rem; cursor: pointer;">
                        Print this QR Code
                    </button>
                </div>
                <div class="footer">
                    Vehicle Verification System
                </div>
            </body>
        </html>
    `);
    printWindow.document.close();
    
    // Auto-trigger print dialog after page loads
    printWindow.onload = function() {
        setTimeout(function() {
            printWindow.print();
        }, 500);
    };
    
    showToast('QR code sent to printer', 'success');
}

function downloadQrCode() {
    const qrImage = document.getElementById('qrCodeImage');
    const vehicleNumber = document.getElementById('vehicle_number').value;
    
    const link = document.createElement('a');
    link.download = `vehicle-qr-${vehicleNumber}.png`;
    link.href = qrImage.src;
    link.click();
    
    showToast('QR code downloaded successfully', 'success');
}

function showToast(message, type = 'success') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    
    // Create toast
    const toast = document.createElement('div');
    toast.className = `flex items-center p-4 mb-3 max-w-md rounded-lg shadow-lg ${
        type === 'success' 
            ? 'bg-gray-900 border-l-4 border-green-500 text-white' 
            : 'bg-gray-900 border-l-4 border-red-500 text-white'
    } opacity-0 transform translate-y-2 transition-all duration-300`;
    
    // Add icon
    const icon = document.createElement('div');
    icon.className = 'flex-shrink-0 w-6 h-6 mr-3';
    icon.innerHTML = type === 'success'
        ? `<svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg>`
        : `<svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg>`;
    
    // Add message
    const messageEl = document.createElement('div');
    messageEl.className = 'text-sm font-medium';
    messageEl.textContent = message;
    
    // Add close button
    const closeButton = document.createElement('button');
    closeButton.className = `ml-auto -mx-1.5 -my-1.5 rounded-lg focus:ring-2 p-1.5 inline-flex h-8 w-8 ${
        type === 'success' ? 'text-green-400 hover:bg-gray-800 focus:ring-green-500' : 'text-red-400 hover:bg-gray-800 focus:ring-red-500'
    }`;
    closeButton.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
    </svg>`;
    closeButton.addEventListener('click', () => {
        toast.classList.add('opacity-0', 'translate-y-2');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    });
    
    // Assemble toast
    toast.appendChild(icon);
    toast.appendChild(messageEl);
    toast.appendChild(closeButton);
    
    // Add to container
    toastContainer.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.classList.remove('opacity-0', 'translate-y-2');
    }, 10);
    
    // Auto remove after delay
    setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-2');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 5000);
}
</script>
{% endblock %}